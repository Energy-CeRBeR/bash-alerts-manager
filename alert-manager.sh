#!/bin/bash

# Alert Manager - –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# ===================================
# –ê–≤—Ç–æ—Ä: Alert Manager System
# –û–ø–∏—Å–∞–Ω–∏–µ: –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–ª–µ—Ä—Ç–æ–≤

set -euo pipefail

# –ü–æ–ª—É—á–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! -f "$SCRIPT_DIR/alert-manager.conf" ]]; then
    echo "–û–®–ò–ë–ö–ê: alert-manager.conf –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ alert-manager"
    exit 1
fi

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
source "$SCRIPT_DIR/alert-manager.conf"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
check_dependencies() {
    local missing_deps=()
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã
    for cmd in bc ps free df top uptime; do
        if ! command -v "$cmd" &> /dev/null; then
            missing_deps+=("$cmd")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo "–û–®–ò–ë–ö–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${missing_deps[*]}"
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–∫–µ—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
        exit 1
    fi
}

# –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
show_banner() {
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                              ALERT MANAGER                                   ‚ïë
‚ïë                         –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã                       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
}

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
show_usage() {
    cat << EOF
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–ö–û–ú–ê–ù–î–ê] [–û–ü–¶–ò–ò]

–ö–æ–º–∞–Ω–¥—ã:
  run                    - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–¥–∏–Ω —Ä–∞–∑
  install               - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á—É
  uninstall            - –£–¥–∞–ª–∏—Ç—å cron –∑–∞–¥–∞—á—É
  status               - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  test                 - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å –Ω–∏–∑–∫–∏–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏
  summary              - –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –∞–ª–µ—Ä—Ç–æ–≤ –∏–∑ –ª–æ–≥ —Ñ–∞–π–ª–∞
  help                 - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏

–û–ø—Ü–∏–∏:
  --config FILE        - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  --verbose           - –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
  --dry-run           - –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä—ã:
  $0 run                          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–¥–∏–Ω —Ä–∞–∑
  $0 install                      # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á—É
  $0 test                         # –¢–µ—Å—Ç —Å –Ω–∏–∑–∫–∏–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏
  $0 status                       # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
  $0 summary                      # –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –∞–ª–µ—Ä—Ç–æ–≤
EOF
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
show_status() {
    echo "–°—Ç–∞—Ç—É—Å Alert Manager"
    echo "==================="
    echo ""
    
    # –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
    echo "  –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: $SCRIPT_DIR/alert-manager.conf"
    echo "  –õ–æ–≥ —Ñ–∞–π–ª: ${LOG_FILE}"
    echo "  –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: ${CHECK_INTERVAL} –º–∏–Ω—É—Ç"
    echo "  –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: ${TEST_MODE:-false}"
    echo ""
    
    # –ü–æ—Ä–æ–≥–∏
    echo "–ü–æ—Ä–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
    if [[ "${TEST_MODE:-false}" == "true" ]]; then
        echo "  CPU: ${TEST_CPU_THRESHOLD:-$CPU_THRESHOLD}% (–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú)"
        echo "  –ü–∞–º—è—Ç—å: ${TEST_RAM_THRESHOLD:-$RAM_THRESHOLD}% (–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú)"
        echo "  –î–∏—Å–∫: ${TEST_DISK_THRESHOLD:-$DISK_THRESHOLD}% (–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú)"
        echo "  –ü—Ä–æ—Ü–µ—Å—Å—ã: ${TEST_PROCESS_THRESHOLD:-$PROCESS_THRESHOLD} (–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú)"
    else
        echo "  CPU: ${CPU_THRESHOLD}%"
        echo "  –ü–∞–º—è—Ç—å: ${RAM_THRESHOLD}%"
        echo "  –î–∏—Å–∫: ${DISK_THRESHOLD}%"
        echo "  –ü—Ä–æ—Ü–µ—Å—Å—ã: ${PROCESS_THRESHOLD}"
    fi
    echo ""
    
    # –°—Ç–∞—Ç—É—Å Cron
    echo "–°—Ç–∞—Ç—É—Å Cron –∑–∞–¥–∞—á–∏:"
    if crontab -l 2>/dev/null | grep -q "alert-manager.sh"; then
        echo "  –°—Ç–∞—Ç—É—Å: –£–°–¢–ê–ù–û–í–õ–ï–ù–ê"
        echo "  –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $(crontab -l 2>/dev/null | grep "alert-manager.sh" | awk '{print $1, $2, $3, $4, $5}')"
    else
        echo "  –°—Ç–∞—Ç—É—Å: –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê"
    fi
    echo ""
    
    # –°—Ç–∞—Ç—É—Å –ª–æ–≥ —Ñ–∞–π–ª–∞
    echo "–°—Ç–∞—Ç—É—Å –ª–æ–≥ —Ñ–∞–π–ª–∞:"
    if [[ -f "${LOG_FILE}" ]]; then
        echo "  –§–∞–π–ª: –°–£–©–ï–°–¢–í–£–ï–¢"
        echo "  –†–∞–∑–º–µ—Ä: $(du -h "${LOG_FILE}" | cut -f1)"
        echo "  –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: $(stat -c %y "${LOG_FILE}" 2>/dev/null | cut -d. -f1)"
        echo "  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª–µ—Ä—Ç–æ–≤: $(grep -c "üö® ALERT TRIGGERED üö®" "${LOG_FILE}" 2>/dev/null || echo "0")"
    else
        echo "  –§–∞–π–ª: –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢"
    fi
}

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cron –∑–∞–¥–∞—á—É
install_cron() {
    local cron_schedule="*/${CHECK_INTERVAL} * * * *"
    local cron_command="$SCRIPT_DIR/alert-manager.sh run >> $SCRIPT_DIR/cron.log 2>&1"
    
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ cron –∑–∞–¥–∞—á–∏ Alert Manager..."
    echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –ö–∞–∂–¥—ã–µ ${CHECK_INTERVAL} –º–∏–Ω—É—Ç"
    echo "–ö–æ–º–∞–Ω–¥–∞: $cron_command"
    
    # –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ crontab
    crontab -l > /tmp/crontab_backup 2>/dev/null || true
    
    # –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ alert-manager
    crontab -l 2>/dev/null | grep -v "alert-manager.sh" > /tmp/crontab_new || true
    
    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
    echo "$cron_schedule $cron_command" >> /tmp/crontab_new
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π crontab
    crontab /tmp/crontab_new
    
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "Alert manager –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–µ ${CHECK_INTERVAL} –º–∏–Ω—É—Ç."
    echo "–õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤: $SCRIPT_DIR/cron.log"
}

# –£–¥–∞–ª–∏—Ç—å cron –∑–∞–¥–∞—á—É
uninstall_cron() {
    echo "–£–¥–∞–ª–µ–Ω–∏–µ cron –∑–∞–¥–∞—á–∏ Alert Manager..."
    
    # –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ alert-manager –∏–∑ crontab
    crontab -l 2>/dev/null | grep -v "alert-manager.sh" > /tmp/crontab_new || true
    crontab /tmp/crontab_new
    
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
}

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
run_monitoring() {
    echo "–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Alert Manager..."
    
    # –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
    chmod +x "$SCRIPT_DIR/scripts/alert-manager.sh"
    chmod +x "$SCRIPT_DIR/scripts/observability/"*.sh
    chmod +x "$SCRIPT_DIR/scripts/alerts/"*.sh
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    "$SCRIPT_DIR/scripts/alert-manager.sh"
    
    echo "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω."
}

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
run_test() {
    echo "–ó–∞–ø—É—Å–∫ Alert Manager –≤ –¢–ï–°–¢–û–í–û–ú –†–ï–ñ–ò–ú–ï..."
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∏–∑–∫–∏—Ö –ø–æ—Ä–æ–≥–æ–≤ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏..."
    
    # –í—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
    local original_test_mode="${TEST_MODE:-false}"
    export TEST_MODE=true
    
    run_monitoring
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
    export TEST_MODE="$original_test_mode"
    
    echo ""
    echo "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞–ª–µ—Ä—Ç–æ–≤:"
    echo "  –õ–æ–≥ —Ñ–∞–π–ª: ${LOG_FILE}"
    echo "  –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–ª–µ—Ä—Ç–æ–≤: tail -50 '${LOG_FILE}'"
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –∞–ª–µ—Ä—Ç–æ–≤
show_summary() {
    if [[ -f "$SCRIPT_DIR/scripts/alerts/file_alert.sh" ]]; then
        "$SCRIPT_DIR/scripts/alerts/file_alert.sh" summary "${LOG_FILE}"
    else
        echo "–°–∫—Ä–∏–ø—Ç —Å–≤–æ–¥–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
        exit 1
    fi
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    local command="${1:-help}"
    
    # –†–∞–∑–±–æ—Ä –æ–ø—Ü–∏–π
    while [[ $# -gt 0 ]]; do
        case $1 in
            --config)
                CONFIG_FILE="$2"
                shift 2
                ;;
            --verbose)
                set -x
                shift
                ;;
            --dry-run)
                echo "–†–ï–ñ–ò–ú –ü–†–û–ë–ù–û–ì–û –ó–ê–ü–£–°–ö–ê - –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –≤–Ω–µ—Å–µ–Ω—ã"
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    # –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –ø–æ—Å–ª–µ —Ä–∞–∑–±–æ—Ä–∞ –æ–ø—Ü–∏–π
    command="${1:-help}"
    
    case "$command" in
        "run")
            check_dependencies
            run_monitoring
            ;;
        "install")
            check_dependencies
            install_cron
            ;;
        "uninstall")
            uninstall_cron
            ;;
        "status")
            show_status
            ;;
        "test")
            check_dependencies
            run_test
            ;;
        "summary")
            show_summary
            ;;
        "help"|*)
            show_banner
            echo ""
            show_usage
            ;;
    esac
}

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main "$@"
