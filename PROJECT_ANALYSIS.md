# Полный разбор проекта Alert Manager

## Обзор архитектуры

Alert Manager построен по модульному принципу с четким разделением ответственности:

- **Конфигурация** - централизованные настройки
- **Мониторинг** - специализированные модули для каждого ресурса
- **Алерты** - система уведомлений и форматирования
- **Утилиты** - вспомогательные функции
- **Управление** - установка, тестирование, автоматизация

---

## Детальный разбор файлов

### 1. Конфигурационные файлы

#### `alert-manager.conf`
**Назначение**: Центральный конфигурационный файл системы

**Содержимое**:
- **Основные настройки**:
  - `LOG_FILE` - путь к файлу логов
  - `CHECK_INTERVAL` - интервал проверки в минутах
  - `ENABLE_ALERTS` - глобальное включение/выключение алертов
  - `ALERT_COOLDOWN` - пауза между повторными алертами

- **Пороги мониторинга**:
  - `CPU_THRESHOLD` - критический уровень загрузки CPU (%)
  - `RAM_THRESHOLD` - критический уровень использования RAM (%)
  - `DISK_THRESHOLD` - критический уровень заполнения диска (%)
  - `PROCESS_THRESHOLD` - максимальное количество процессов

- **Тестовый режим**:
  - `TEST_MODE` - включение режима тестирования
  - `TEST_*_THRESHOLD` - заниженные пороги для тестирования

**Особенности**:
- Поддержка комментариев (строки начинающиеся с #)
- Формат `КЛЮЧ=ЗНАЧЕНИЕ`
- Автоматическая валидация значений

---

### 2. Главные исполняемые файлы

#### `alert-manager.sh`
**Назначение**: Главная точка входа в систему

**Функциональность**:
- **Команды управления**:
  - `run` - однократный запуск мониторинга
  - `install` - установка cron job
  - `uninstall` - удаление cron job
  - `status` - показ текущего статуса
  - `test` - тестовый запуск с низкими порогами
  - `summary` - сводка по алертам
  - `help` - справочная информация

**Алгоритм работы**:
1. Загрузка конфигурации через `config_parser.sh`
2. Проверка режима работы (обычный/тестовый)
3. Вызов соответствующих модулей мониторинга
4. Обработка результатов и генерация алертов

**Особенности**:
- Проверка зависимостей при запуске
- Автоматическое создание директорий
- Обработка ошибок и логирование

---

### 3. Утилиты (`scripts/utils/`)

#### `config_parser.sh`
**Назначение**: Парсинг и валидация конфигурационного файла

**Функции**:
- `load_config()` - загрузка конфигурации из файла
- `validate_config()` - проверка корректности параметров
- `get_config_value()` - получение значения параметра
- `set_test_mode()` - переключение в тестовый режим

**Алгоритм**:
1. Чтение файла построчно
2. Игнорирование комментариев и пустых строк
3. Парсинг пар ключ=значение
4. Валидация типов данных (числа, булевы значения)
5. Установка значений по умолчанию

#### `logger.sh`
**Назначение**: Централизованная система логирования

**Функции**:
- `log_info()` - информационные сообщения
- `log_warning()` - предупреждения
- `log_error()` - ошибки
- `log_debug()` - отладочная информация
- `setup_logging()` - инициализация системы логов

**Особенности**:
- Цветной вывод в терминал
- Временные метки в формате ISO 8601
- Ротация логов при превышении размера
- Различные уровни детализации

#### `system_info.sh`
**Назначение**: Сбор системной информации

**Функции**:
- `get_system_info()` - общая информация о системе
- `get_cpu_info()` - информация о процессоре
- `get_memory_info()` - информация о памяти
- `get_disk_info()` - информация о дисках
- `get_network_info()` - сетевая информация
- `get_uptime()` - время работы системы

**Источники данных**:
- `/proc/cpuinfo` - информация о CPU
- `/proc/meminfo` - информация о памяти
- `/proc/loadavg` - средняя загрузка
- `df` - использование дисков
- `ps` - информация о процессах

#### `alert_formatter.sh`
**Назначение**: Форматирование алертов для красивого вывода

**Функции**:
- `format_alert_header()` - заголовок алерта
- `format_alert_body()` - основное содержимое
- `format_system_details()` - детали системы
- `format_process_list()` - список процессов
- `add_separator()` - разделители секций

**Стили форматирования**:
- ASCII-арт заголовки
- Цветовое кодирование по уровню критичности
- Табличное представление данных
- Прогресс-бары для процентных значений

---

### 4. Модули мониторинга (`scripts/observability/`)

#### `cpu_monitor.sh`
**Назначение**: Мониторинг загрузки процессора

**Метрики**:
- Общая загрузка CPU (%)
- Загрузка по ядрам
- Load Average (1, 5, 15 минут)
- Топ процессов по CPU

**Алгоритм**:
1. Чтение `/proc/stat` для получения времени CPU
2. Расчет процента загрузки за интервал
3. Получение Load Average из `/proc/loadavg`
4. Сортировка процессов по использованию CPU
5. Сравнение с пороговым значением

**Источники данных**:
- `/proc/stat` - статистика CPU
- `/proc/loadavg` - средняя загрузка
- `top` или `ps` - процессы

#### `ram_monitor.sh`
**Назначение**: Мониторинг использования оперативной памяти

**Метрики**:
- Общий объем RAM
- Используемая память
- Свободная память
- Буферы и кэш
- Swap использование

**Алгоритм**:
1. Парсинг `/proc/meminfo`
2. Расчет процента использования
3. Анализ swap-файла
4. Определение топ процессов по памяти
5. Проверка порогового значения

**Формула расчета**:
\`\`\`
Использовано% = (Общая - Доступная) / Общая * 100
\`\`\`

#### `disk_monitor.sh`
**Назначение**: Мониторинг использования дискового пространства

**Метрики**:
- Использование по файловым системам
- Свободное место
- Inodes использование
- I/O статистика

**Алгоритм**:
1. Выполнение `df -h` для получения использования
2. Парсинг вывода и извлечение процентов
3. Проверка каждой файловой системы
4. Исключение временных и системных FS
5. Сравнение с пороговым значением

**Исключения**:
- tmpfs, devtmpfs
- proc, sys, dev
- snap-пакеты

#### `process_monitor.sh`
**Назначение**: Мониторинг количества запущенных процессов

**Метрики**:
- Общее количество процессов
- Процессы по состояниям (running, sleeping, zombie)
- Процессы по пользователям
- Системные vs пользовательские процессы

**Алгоритм**:
1. Подсчет процессов через `/proc/`
2. Анализ состояний процессов
3. Группировка по пользователям
4. Выявление zombie-процессов
5. Сравнение с пороговым значением

---

### 5. Система алертов (`scripts/alerts/`)

#### `file_alert.sh`
**Назначение**: Запись алертов в файл с красивым форматированием

**Функции**:
- `write_alert()` - основная функция записи
- `append_system_info()` - добавление системной информации
- `format_timestamp()` - форматирование времени
- `rotate_log_if_needed()` - ротация больших файлов

**Структура алерта**:
\`\`\`
🚨 ALERT TRIGGERED 🚨
=====================
Timestamp: 2024-01-15 14:30:25
Alert Type: HIGH CPU USAGE
Current Value: 85.5%
Threshold: 80%
Status: CRITICAL

[Детальная информация о системе]
[Список процессов]
[Рекомендации]
=====================
\`\`\`

**Особенности**:
- Автоматическая ротация при превышении размера
- Блокировка файла при записи
- Резервное копирование старых логов
- Сжатие архивных файлов

---

### 6. Скрипты установки и управления

#### `scripts/install.sh`
**Назначение**: Автоматическая установка и настройка системы

**Этапы установки**:
1. **Проверка системы**:
   - Версия Ubuntu
   - Наличие необходимых пакетов
   - Права доступа

2. **Установка зависимостей**:
   - `bc` - для вычислений с плавающей точкой
   - `cron` - для автоматического запуска
   - `procps` - для работы с процессами

3. **Настройка прав доступа**:
   - Исполняемые права для всех скриптов
   - Создание директорий для логов
   - Настройка владельца файлов

4. **Проверка конфигурации**:
   - Валидация `alert-manager.conf`
   - Создание файла логов
   - Тестовый запуск

#### `scripts/uninstall.sh`
**Назначение**: Полное удаление системы

**Этапы удаления**:
1. Удаление cron job
2. Остановка запущенных процессов
3. Удаление файлов логов (опционально)
4. Восстановление исходного состояния

#### `scripts/test_runner.sh`
**Назначение**: Комплексное тестирование системы

**Тесты**:
1. **Модульные тесты**:
   - Тестирование каждого монитора отдельно
   - Проверка парсера конфигурации
   - Тестирование системы логирования

2. **Интеграционные тесты**:
   - Полный цикл мониторинга
   - Генерация алертов
   - Работа с cron

3. **Нагрузочные тесты**:
   - Создание искусственной нагрузки
   - Проверка срабатывания алертов
   - Тестирование производительности

---

## Алгоритм работы системы

### 1. Инициализация
\`\`\`
alert-manager.sh run
    ↓
config_parser.sh → Загрузка конфигурации
    ↓
logger.sh → Инициализация логирования
    ↓
system_info.sh → Сбор базовой информации о системе
\`\`\`

### 2. Мониторинг
\`\`\`
Для каждого типа ресурса:
    ↓
observability/*_monitor.sh → Сбор метрик
    ↓
Сравнение с пороговыми значениями
    ↓
Если превышен порог → Генерация алерта
\`\`\`

### 3. Алертинг
\`\`\`
alert_formatter.sh → Форматирование алерта
    ↓
file_alert.sh → Запись в файл
    ↓
logger.sh → Логирование события
\`\`\`

### 4. Автоматизация
\`\`\`
cron → Запуск по расписанию
    ↓
alert-manager.sh run → Выполнение цикла мониторинга
    ↓
Повтор через CHECK_INTERVAL минут
\`\`\`

---

## Особенности реализации

### Безопасность
- Проверка прав доступа к файлам
- Валидация входных данных
- Защита от race conditions при записи логов
- Ограничение размера файлов логов

### Производительность
- Кэширование системной информации
- Оптимизированные запросы к /proc
- Минимальное использование внешних команд
- Параллельное выполнение мониторов

### Надежность
- Обработка ошибок на всех уровнях
- Автоматическое восстановление после сбоев
- Резервное копирование конфигурации
- Graceful shutdown при получении сигналов

### Расширяемость
- Модульная архитектура
- Стандартизированные интерфейсы
- Конфигурируемые пороги
- Поддержка плагинов

---

## Файлы конфигурации и данных

### Создаваемые автоматически:
- `logs/` - директория для файлов логов
- `alerts.log` - основной файл алертов
- `system.log` - системные логи
- `.alert-manager.pid` - PID файл запущенного процесса

### Временные файлы:
- `/tmp/alert-manager-*` - временные данные мониторинга
- `/var/lock/alert-manager.lock` - файл блокировки

Эта архитектура обеспечивает надежную, производительную и легко расширяемую систему мониторинга с красивым интерфейсом и подробным логированием.
